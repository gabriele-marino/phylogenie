# -----------
# 1. BD trees
# -----------

# This tutorial walks you through setting up a configuration file to simulate phylogenetic trees with a birth-death (BD) model.

# In BD settings there is a single infectious (I) state/population, whose behaviour is parameterized by three values:
# - R_0: reproduction number;
# - T_I: infectious period;
# - s: sampling proportion.

# In this example, we generate a dataset with 100 training samples, 10 validation samples, and 10 test samples. For each sample:
# - The reproduction number is drawn from a lognormal distribution (mean=1, sigma=0.2);
# - The sampling proportion is a skyline (piece-wise) parameter defined as follows with respect to the simulation time t:
#   - 0 for 0<t<1;
#   - randomly drawn at uniform from 0 to 0.1 for 1<t<2;
#   - randomly drawn at uniform from 0.1 to 0.3 for 2<t.
# - The infectious period is fixed at 2.5.

# For each simulation, a target number of leaves between 50 and 250 is drawn uniformly at random, and the simulation ends when the target number of leaves is reached.

# ---------------
# General configs
# ---------------

# This section defines general configurations for the simulation, including output directory, number of samples, number of parallel jobs, and random seed.

output_dir: outputs/BD-Trees # Root directory where the simulated data and metadata will be saved

data_type: trees # Specify the type of data to simulate: "trees" or "msas"

# The number of samples can be an integer as well as a dictionary specifying different numbers for each dataset splits. Dataset splits can have any name; here we use train, val, and test.
n_samples:
  train: 100
  val: 10
  test: 10
# For a single dataset split with 100 samples, use:
# n_samples: 100

n_jobs: -1 # Number of parallel jobs to use; -1 means use all available cores (-1 by default)
seed: 42 # Random seed to ensure reproducibility (None by default)

# -------
# Context
# -------

# The context section is what makes Phylogenie flexible and powerful.
# This section defines the parameters that will be sampled for each dataset item.
# The context is a dictionary of key-value pairs, where each key is a parameter name and the value is a distribution from which the parameter will be sampled.
# Phylogenie supports all the distributions provided by NumPy's random generator. These include, and are not limited to:
# - uniform(low: float, high: float);
# - normal(loc: float, scale: float);
# - lognormal(mean: float, sigma: float);
# - weibull(a: float);
# - exponential(scale: float);
# - gamma(shape: float, scale: float);
# - beta(a: float, b: float);
# - integers(low: int, high: int).
# For a full list of distributions, refer to the NumPy documentation: https://numpy.org/devdocs/reference/random/generator.html#distributions.
# In this case, we sample the reproduction number R_0 from a lognormal distribution and the values of s at different simulation times from uniform distributions. The number of leaves is sampled from a discrete uniform distribution between 50 and 250.
# If specified as strings, the arguments of the distribution are evaluated in the context of the current sample, and can refer to other (previously defined) context variables (cf. 3.BDSS-Trees.yaml).

context:
  R_0:
    type: lognormal
    mean: 1
    sigma: 0.2
  s_t1:
    type: uniform
    low: 0
    high: 0.1
  s_t2:
    type: uniform
    low: 0.1
    high: 0.3
  n_leaves:
    type: integers
    low: 50
    high: 250

# ------------------------------------
# Parameterization-specific parameters
# ------------------------------------

# This section defines the parameters specific to the BD parameterization.
# The BD model uses three parameters:
# - reproduction_number;
# - infectious_period;
# - sampling_proportion.

# All of these arguments are skyline (piece-wise constant) parameters. In Phylogenie, a scalar skyline parameter is simply denoted as SkylineParameter, and can be defined in one of the following ways:
# 1) A (unique) scalar value, meaning the parameter stays constant for the entire simulation;
# 2) As a pair of attributes:
#   - value: a list of values the parameter will take over time;
#   - change_times: a list of times (starting from t=0) when the parameter changes to the next value.
# In this last case, the value list must have exactly one more element than change_times.

# Phylogenie also supports writing scalar values (or lists of them) as strings instead of literal numbers.
# When you do this, Phylogenie will automatically parse and evaluate the string eventually using context variables.
# During evaluation, context variables are converted into NumPy arrays so you can easily apply complex calculations or operations (cf. 2.BDEI-Trees.yaml). 
# In this example, we donâ€™t need to apply complex operations; we just refer directly to the context variables when defining the parameters.

parameterization: BD

reproduction_number: R_0
sampling_proportion:
  value: [0, s_t1, s_t2]
  change_times: [1, 2]
infectious_period: 2.5

# --------------------------
# Tree simulation parameters
# --------------------------

# This section defines the parameters for the tree simulation.
# In this case we specify a minimum and a maximum number of leaves in the simulated trees. At each simulation, a target number of leaves is randomly drawn between the minimum and maximum values, and the simulation stops when the number of leaves reaches the target.

n_leaves: n_leaves # Number of leaves in the simulated trees
node_features:  # Mapping of node feature names to TreeNode attributes to be recorded for each node
  n_leaves: leaf_counts
  depth: depths
  # - ages # Age of each node
  # - depth_levels # Depth level of each node
  # - heights # Height of each node
  # - height_levels # Height level of each node
  # - times # Time of each node

# Other optional arguments are:

# - max_time: float (infinity by default)
#   Maximum time of the simulation. If provided, the simulation will stop when the time reaches this value. It provides an alternative stopping criterion to n_leaves.

# - timed_events: list[TimedEvent] (None by default)
#   A list of timed events to be scheduled during the simulation. Each timed event is defined as a dictionary with the following keys:
#   - type: str
#     The type of the timed event. Can be one of the following:
#     - "sampling": samples a proportion of individuals at specified times.
#   - times: list[float]
#     A list of times when the event will occur.
#   Each timed event type has specific additional arguments.
#   Sampling timed events requires the following additional arguments:
#     - state: str | None (None by default)
#       The state(s) of the individuals to be sampled. Can be a single state or a regex pattern to match multiple states.
#       If None, individuals from all states will be sampled.
#     - proportion: float
#       The proportion of individuals to be sampled at each event time.
#     - removal: bool
#       Whether the sampled individuals are removed from the population (True) or not (False).
#    For an example of how to use sampling timed events, refer to 6.FBD-Trees.yaml.

# - timeout: float (infinity by default)
#   The maximum time (in seconds) allowed for the simulation. If the simulation exceeds this time, a new set of parameters will be drawn and the simulation restarted.

# - acceptance_criterion: str (None by default)
#   A string representing a Python boolean function that takes a TreeNode object named "tree" as input and returns True if the tree meets the acceptance criterion, and False otherwise. If provided, the simulation will continue until a tree satisfying the criterion is generated. The function can refer to any attribute or method of the Phylogenie TreeNode class (cfr. 6.FBD-Trees.yaml).

# - logs: dict[str, str] (None by default)
#   A dictionary where keys are names of additional log entries and values are strings representing Python expressions to compute the corresponding log values from the simulated tree. The expressions can refer to any attribute or method of the Phylogenie TreeNode class.